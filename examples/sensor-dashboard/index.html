<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>ORPHE CORE JS DEMO</title>
    <link rel="stylesheet" href="../../assets/css/orphe_insole.css">
</head>

<body>
    <div class="container">
        <header>
            <img src="../../assets/images/orphe.svg" alt="ORPHE" style="height: 40px; margin-bottom: 10px;">
            <div class="subtitle">ORPHE-INSOLE.js - Sensor Dashboard</div>
        </header>

        <div class="main-content">
            <!-- Device 1 Column -->
            <div class="device-column">
                <div class="device-header">
                    <div class="device-title">Device 1</div>
                    <div style="margin-bottom: 15px;">
                        <span class="status-indicator" id="status-indicator-0"></span>
                        <span id="connection-text-0">Sensor 1: Not Connected</span>
                    </div>
                    <div class="device-controls">
                        <button onclick="connectDevice(0);" id="connect-btn-0">Connect Device 1</button>
                    </div>
                </div>

                <div class="sensor-grid">
                    <!-- Left Accelerometer Card -->
                    <div class="sensor-card">
                        <div class="sensor-title">Accelerometer</div>
                        <div class="sensor-values">
                            <div class="value-row">
                                <span class="value-label">X</span>
                                <span class="value-number" id="acc-x-0">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Y</span>
                                <span class="value-number" id="acc-y-0">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Z</span>
                                <span class="value-number" id="acc-z-0">0.000</span>
                            </div>
                        </div>
                        <div class="meta-info">
                            <div>Timestamp: <span id="acc-timestamp-0">—</span></div>
                            <div>Packet: <span id="acc-packet-0">—</span></div>
                        </div>
                    </div>

                    <!-- Left Gyroscope Card -->
                    <div class="sensor-card">
                        <div class="sensor-title">Gyroscope</div>
                        <div class="sensor-values">
                            <div class="value-row">
                                <span class="value-label">X</span>
                                <span class="value-number" id="gyro-x-0">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Y</span>
                                <span class="value-number" id="gyro-y-0">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Z</span>
                                <span class="value-number" id="gyro-z-0">0.000</span>
                            </div>
                        </div>
                        <div class="meta-info">
                            <div>Timestamp: <span id="gyro-timestamp-0">—</span></div>
                            <div>Packet: <span id="gyro-packet-0">—</span></div>
                        </div>
                    </div>

                    <!-- Left Pressure Card -->
                    <div class="sensor-card">
                        <div class="sensor-title">Pressure Sensors</div>
                        <div class="sensor-values">
                            <div class="value-row">
                                <span class="value-label">Sensor 1</span>
                                <span class="value-number" id="press-0-0">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Sensor 2</span>
                                <span class="value-number" id="press-1-0">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Sensor 3</span>
                                <span class="value-number" id="press-2-0">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Sensor 4</span>
                                <span class="value-number" id="press-3-0">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Sensor 5</span>
                                <span class="value-number" id="press-4-0">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Sensor 6</span>
                                <span class="value-number" id="press-5-0">0.000</span>
                            </div>
                        </div>
                        <div class="meta-info">
                            <div>Timestamp: <span id="press-timestamp-0">—</span></div>
                            <div>Packet: <span id="press-packet-0">—</span></div>
                        </div>
                    </div>

                    <!-- Left Quaternion Card -->
                    <div class="sensor-card quaternion-card">
                        <div class="sensor-title">Quaternion</div>
                        <div class="quaternion-values">
                            <div class="value-row">
                                <span class="value-label">W</span>
                                <span class="value-number" id="quat-w-0">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">X</span>
                                <span class="value-number" id="quat-x-0">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Y</span>
                                <span class="value-number" id="quat-y-0">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Z</span>
                                <span class="value-number" id="quat-z-0">0.000</span>
                            </div>
                        </div>
                        <div class="meta-info">
                            <div>Timestamp: <span id="quat-timestamp-0">—</span></div>
                            <div>Packet: <span id="quat-packet-0">—</span></div>
                        </div>
                    </div>

                    <!-- Left STATUS Panel -->
                    <div class="sensor-card">
                        <div class="sensor-title">STATUS</div>

                        <div class="status-message" id="chrome-flag-message-0" style="display: none;">
                            <div style="padding: 20px; text-align: center;">
                                <h3>⚠️ Chrome Experimental Features Required</h3>
                                <p style="margin: 15px 0; color: #888;">
                                    To receive advertisement data from ORPHE devices, you need to enable experimental
                                    Web Bluetooth features in Chrome.
                                </p>
                                <ol style="text-align: left; color: #ccc; margin: 20px 0;">
                                    <li>Go to <code>chrome://flags/#enable-experimental-web-platform-features</code>
                                    </li>
                                    <li>Set it to "Enabled"</li>
                                    <li>Restart Chrome</li>
                                </ol>
                                <p style="color: #888; font-size: 0.9rem;">
                                    Once enabled, connect your ORPHE device to see battery info, device details, and
                                    more.
                                </p>
                            </div>
                        </div>

                        <div class="advertisement-data" id="advertisement-data-0" style="display: none;">
                            <div class="value-row">
                                <span class="value-label">Device Name</span>
                                <span class="value-number" id="ad-name-0">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Device ID</span>
                                <span class="value-number" id="ad-id-0">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">RSSI</span>
                                <span class="value-number" id="ad-rssi-0">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">TX Power</span>
                                <span class="value-number" id="ad-txpower-0">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Battery</span>
                                <span class="value-number" id="ad-battery-0">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Model Type</span>
                                <span class="value-number" id="ad-model-type-0">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Position</span>
                                <span class="value-number" id="ad-mounting-position-0">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Activity</span>
                                <span class="value-number" id="ad-human-activity-0">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Version</span>
                                <span class="value-number" id="ad-version-0">—</span>
                            </div>
                        </div>

                        <div class="no-advertisement" id="no-advertisement-0" style="display: none;">
                            <div style="text-align: center; color: #888; padding: 20px;">
                                Connect to ORPHE device to see advertisement data
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Device 2 Column -->
            <div class="device-column">
                <div class="device-header">
                    <div class="device-title">Device 2</div>
                    <div style="margin-bottom: 15px;">
                        <span class="status-indicator" id="status-indicator-1"></span>
                        <span id="connection-text-1">Sensor 2: Not Connected</span>
                    </div>
                    <div class="device-controls">
                        <button onclick="connectDevice(1);" id="connect-btn-1">Connect Device 2</button>
                    </div>
                </div>

                <div class="sensor-grid">
                    <!-- Right Accelerometer Card -->
                    <div class="sensor-card">
                        <div class="sensor-title">Accelerometer</div>
                        <div class="sensor-values">
                            <div class="value-row">
                                <span class="value-label">X</span>
                                <span class="value-number" id="acc-x-1">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Y</span>
                                <span class="value-number" id="acc-y-1">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Z</span>
                                <span class="value-number" id="acc-z-1">0.000</span>
                            </div>
                        </div>
                        <div class="meta-info">
                            <div>Timestamp: <span id="acc-timestamp-1">—</span></div>
                            <div>Packet: <span id="acc-packet-1">—</span></div>
                        </div>
                    </div>

                    <!-- Right Gyroscope Card -->
                    <div class="sensor-card">
                        <div class="sensor-title">Gyroscope</div>
                        <div class="sensor-values">
                            <div class="value-row">
                                <span class="value-label">X</span>
                                <span class="value-number" id="gyro-x-1">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Y</span>
                                <span class="value-number" id="gyro-y-1">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Z</span>
                                <span class="value-number" id="gyro-z-1">0.000</span>
                            </div>
                        </div>
                        <div class="meta-info">
                            <div>Timestamp: <span id="gyro-timestamp-1">—</span></div>
                            <div>Packet: <span id="gyro-packet-1">—</span></div>
                        </div>
                    </div>

                    <!-- Right Pressure Card -->
                    <div class="sensor-card">
                        <div class="sensor-title">Pressure Sensors</div>
                        <div class="sensor-values">
                            <div class="value-row">
                                <span class="value-label">Sensor 1</span>
                                <span class="value-number" id="press-0-1">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Sensor 2</span>
                                <span class="value-number" id="press-1-1">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Sensor 3</span>
                                <span class="value-number" id="press-2-1">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Sensor 4</span>
                                <span class="value-number" id="press-3-1">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Sensor 5</span>
                                <span class="value-number" id="press-4-1">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Sensor 6</span>
                                <span class="value-number" id="press-5-1">0.000</span>
                            </div>
                        </div>
                        <div class="meta-info">
                            <div>Timestamp: <span id="press-timestamp-1">—</span></div>
                            <div>Packet: <span id="press-packet-1">—</span></div>
                        </div>
                    </div>

                    <!-- Right Quaternion Card -->
                    <div class="sensor-card quaternion-card">
                        <div class="sensor-title">Quaternion</div>
                        <div class="quaternion-values">
                            <div class="value-row">
                                <span class="value-label">W</span>
                                <span class="value-number" id="quat-w-1">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">X</span>
                                <span class="value-number" id="quat-x-1">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Y</span>
                                <span class="value-number" id="quat-y-1">0.000</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Z</span>
                                <span class="value-number" id="quat-z-1">0.000</span>
                            </div>
                        </div>
                        <div class="meta-info">
                            <div>Timestamp: <span id="quat-timestamp-1">—</span></div>
                            <div>Packet: <span id="quat-packet-1">—</span></div>
                        </div>
                    </div>

                    <!-- Right STATUS Panel -->
                    <div class="sensor-card">
                        <div class="sensor-title">STATUS</div>

                        <div class="status-message" id="chrome-flag-message-1" style="display: none;">
                            <div style="padding: 20px; text-align: center;">
                                <h3>⚠️ Chrome Experimental Features Required</h3>
                                <p style="margin: 15px 0; color: #888;">
                                    To receive advertisement data from ORPHE devices, you need to enable experimental
                                    Web Bluetooth features in Chrome.
                                </p>
                                <ol style="text-align: left; color: #ccc; margin: 20px 0;">
                                    <li>Go to <code>chrome://flags/#enable-experimental-web-platform-features</code>
                                    </li>
                                    <li>Set it to "Enabled"</li>
                                    <li>Restart Chrome</li>
                                </ol>
                                <p style="color: #888; font-size: 0.9rem;">
                                    Once enabled, connect your ORPHE device to see battery info, device details, and
                                    more.
                                </p>
                            </div>
                        </div>

                        <div class="advertisement-data" id="advertisement-data-1" style="display: none;">
                            <div class="value-row">
                                <span class="value-label">Device Name</span>
                                <span class="value-number" id="ad-name-1">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Device ID</span>
                                <span class="value-number" id="ad-id-1">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">RSSI</span>
                                <span class="value-number" id="ad-rssi-1">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">TX Power</span>
                                <span class="value-number" id="ad-txpower-1">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Battery</span>
                                <span class="value-number" id="ad-battery-1">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Model Type</span>
                                <span class="value-number" id="ad-model-type-1">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Position</span>
                                <span class="value-number" id="ad-mounting-position-1">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Activity</span>
                                <span class="value-number" id="ad-human-activity-1">—</span>
                            </div>
                            <div class="value-row">
                                <span class="value-label">Version</span>
                                <span class="value-number" id="ad-version-1">—</span>
                            </div>
                        </div>

                        <div class="no-advertisement" id="no-advertisement-1" style="display: none;">
                            <div style="text-align: center; color: #888; padding: 20px;">
                                Connect to ORPHE device to see advertisement data
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="../../src/ORPHE-INSOLE.js" crossorigin="anonymous"></script>
        <script>
            var insole = [new Orphe(0), new Orphe(1)]; // Device 1(0)とDevice 2(1)のセンサー
            var isConnected = [false, false];

            // Chrome実験的機能の確認（UI表示用）
            function checkChromeExperimentalFeatures() {
                const chromeMessage0 = document.getElementById('chrome-flag-message-0');
                const chromeMessage1 = document.getElementById('chrome-flag-message-1');
                const advertisementData0 = document.getElementById('advertisement-data-0');
                const advertisementData1 = document.getElementById('advertisement-data-1');
                const noAdvertisement0 = document.getElementById('no-advertisement-0');
                const noAdvertisement1 = document.getElementById('no-advertisement-1');

                // watchAdvertisements APIが利用可能かチェック
                if (!navigator.bluetooth || !BluetoothDevice.prototype.watchAdvertisements) {
                    // Chrome実験的機能が無効の場合
                    chromeMessage0.style.display = 'block';
                    chromeMessage1.style.display = 'block';
                    advertisementData0.style.display = 'none';
                    advertisementData1.style.display = 'none';
                    noAdvertisement0.style.display = 'none';
                    noAdvertisement1.style.display = 'none';
                    return false;
                } else {
                    // Chrome実験的機能が有効の場合
                    chromeMessage0.style.display = 'none';
                    chromeMessage1.style.display = 'none';
                    noAdvertisement0.style.display = 'block';
                    noAdvertisement1.style.display = 'block';
                    return true;
                }
            }

            // バッテリー情報を解析する関数
            function parseBatteryInfo(batteryValue) {
                if (batteryValue === undefined || batteryValue === null) return '—';

                const chargingFlag = (batteryValue & 0xF0) >> 4; // 上位4ビット
                const batteryLevel = batteryValue & 0x0F; // 下位4ビット

                // バッテリー残量の表示
                let levelText;
                switch (batteryLevel) {
                    case 0: levelText = 'Low'; break;
                    case 1: levelText = 'Mid'; break;
                    case 2: levelText = 'High'; break;
                    default: levelText = 'Unknown'; break;
                }

                // 充電状態の表示
                let chargingText;
                switch (chargingFlag) {
                    case 0x0: chargingText = ''; break; // チャージなし
                    case 0x1: chargingText = ' (MAT Charging)'; break; // MATチャージ
                    case 0x2: chargingText = ' (Wired Power)'; break; // 有線給電
                    default: chargingText = ' (Unknown)'; break;
                }

                return `${levelText}${chargingText}`;
            }

            // アドバタイズメントデータを表示（gotStatusの形式に対応）
            function updateAdvertisementData(deviceIndex, status) {
                const advertisementData = document.getElementById(`advertisement-data-${deviceIndex}`);
                const noAdvertisement = document.getElementById(`no-advertisement-${deviceIndex}`);

                if (status) {
                    document.getElementById(`ad-name-${deviceIndex}`).textContent = status.name || '—';
                    document.getElementById(`ad-id-${deviceIndex}`).textContent = status.id || '—';
                    document.getElementById(`ad-rssi-${deviceIndex}`).textContent = status.rssi !== undefined ? `${status.rssi} dBm` : '—';
                    document.getElementById(`ad-txpower-${deviceIndex}`).textContent = status.txPower !== undefined ? `${status.txPower} dBm` : '—';
                    document.getElementById(`ad-battery-${deviceIndex}`).textContent = parseBatteryInfo(status.battery);
                    document.getElementById(`ad-model-type-${deviceIndex}`).textContent = status.model_type !== undefined ? status.model_type : '—';
                    document.getElementById(`ad-mounting-position-${deviceIndex}`).textContent = status.mounting_position !== undefined ? status.mounting_position : '—';
                    document.getElementById(`ad-human-activity-${deviceIndex}`).textContent = status.human_activity_recognition !== undefined ? status.human_activity_recognition : '—';
                    document.getElementById(`ad-version-${deviceIndex}`).textContent = status.version || '—';

                    advertisementData.style.display = 'block';
                    noAdvertisement.style.display = 'none';
                } else {
                    advertisementData.style.display = 'none';
                    noAdvertisement.style.display = 'block';
                }
            }

            // UI更新用のヘルパー関数
            function updateConnectionStatus(deviceIndex, connected) {
                isConnected[deviceIndex] = connected;
                const statusIndicator = document.getElementById(`status-indicator-${deviceIndex}`);
                const connectionText = document.getElementById(`connection-text-${deviceIndex}`);
                const connectBtn = document.getElementById(`connect-btn-${deviceIndex}`);
                const deviceName = deviceIndex === 0 ? 'Device 1' : 'Device 2';
                const sensorName = deviceIndex === 0 ? 'Sensor 1' : 'Sensor 2';

                statusIndicator.className = connected ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
                connectionText.textContent = `${sensorName}: ${connected ? 'Connected' : 'Not Connected'}`;
                connectBtn.textContent = connected ? `Disconnect ${deviceName}` : `Connect ${deviceName}`;
            }

            function formatValue(value) {
                if (typeof value === 'number') {
                    return value.toFixed(3);
                }
                return value || '0.000';
            }

            function formatTimestamp(timestamp) {
                if (!timestamp) return '—';
                return new Date(timestamp).toLocaleTimeString();
            }

            function updateValue(elementId, value) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = formatValue(value);
                }
            }

            window.onload = function () {
                // Chrome実験的機能をチェック（UI表示用）
                checkChromeExperimentalFeatures();

                // 両デバイスを初期化
                for (let deviceIndex = 0; deviceIndex < 2; deviceIndex++) {
                    // ORPHE CORE Init
                    insole[deviceIndex].setup();

                    // 接続イベント (クロージャーを使ってdeviceIndexを保持)
                    (function (index) {
                        insole[index].onConnect = function () {
                            updateConnectionStatus(index, true);
                        };

                        insole[index].onDisconnect = function () {
                            updateConnectionStatus(index, false);
                            updateAdvertisementData(index, null);
                        };

                        // センサーデータ受信
                        insole[index].gotConvertedAcc = function (acc) {
                            updateValue(`acc-x-${index}`, acc.x);
                            updateValue(`acc-y-${index}`, acc.y);
                            updateValue(`acc-z-${index}`, acc.z);
                            document.getElementById(`acc-timestamp-${index}`).textContent = formatTimestamp(acc.timestamp);
                            document.getElementById(`acc-packet-${index}`).textContent = acc.packet_number || '—';
                        };

                        insole[index].gotConvertedGyro = function (gyro) {
                            updateValue(`gyro-x-${index}`, gyro.x);
                            updateValue(`gyro-y-${index}`, gyro.y);
                            updateValue(`gyro-z-${index}`, gyro.z);
                            document.getElementById(`gyro-timestamp-${index}`).textContent = formatTimestamp(gyro.timestamp);
                            document.getElementById(`gyro-packet-${index}`).textContent = gyro.packet_number || '—';
                        };

                        insole[index].gotQuat = function (quat) {
                            updateValue(`quat-w-${index}`, quat.w);
                            updateValue(`quat-x-${index}`, quat.x);
                            updateValue(`quat-y-${index}`, quat.y);
                            updateValue(`quat-z-${index}`, quat.z);
                            document.getElementById(`quat-timestamp-${index}`).textContent = formatTimestamp(quat.timestamp);
                            document.getElementById(`quat-packet-${index}`).textContent = quat.packet_number || '—';
                        };

                        insole[index].gotPress = function (press) {
                            // press.values[] 配列の6つの値を表示
                            if (press.values && Array.isArray(press.values)) {
                                for (let i = 0; i < 6; i++) {
                                    const value = press.values[i] || 0;
                                    updateValue(`press-${i}-${index}`, value);
                                }
                            } else {
                                // フォールバック: press.valueが単一値の場合
                                updateValue(`press-0-${index}`, press.value || 0);
                                for (let i = 1; i < 6; i++) {
                                    updateValue(`press-${i}-${index}`, 0);
                                }
                            }
                            document.getElementById(`press-timestamp-${index}`).textContent = formatTimestamp(press.timestamp);
                            document.getElementById(`press-packet-${index}`).textContent = press.packet_number || '—';
                        };

                        // ステータスデータ受信コールバック（アドバタイズメントデータ用）
                        insole[index].gotStatus = function (status) {
                            console.log(`Status data received for device ${index}:`, status);
                            updateAdvertisementData(index, status);
                        };
                    })(deviceIndex);
                }
            };

            function connectDevice(deviceIndex) {
                if (isConnected[deviceIndex]) {
                    insole[deviceIndex].stop();
                    updateConnectionStatus(deviceIndex, false);
                } else {
                    insole[deviceIndex].begin()
                        .then(() => {
                            console.log(`デバイス${deviceIndex + 1}に接続しました`);
                        })
                        .catch(error => {
                            console.error(`デバイス${deviceIndex + 1}接続エラー:`, error);
                            const deviceName = deviceIndex === 0 ? 'Device 1' : 'Device 2';
                            alert(`${deviceName} の接続に失敗しました: ` + error.message);
                        });
                }
            }
        </script>
</body>

</html>