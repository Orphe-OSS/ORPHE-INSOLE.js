<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>ORPHE CORE JS DEMO</title>
    <link rel="stylesheet" href="../assets/css/orphe_insole.css">
</head>

<body>
    <div class="container">
        <header>
            <img src="../../assets/images/orphe.svg" alt="ORPHE" style="height: 40px; margin-bottom: 10px;">
            <div class="subtitle">ORPHE-INSOLE.js - Sensor Dashboard</div>
        </header>

        <div class="main-content dashboard-layout">
            <!-- Connection Controls - Top Section (Compact Buttons) -->
            <div class="connection-controls">
                <button onclick="connectDevice(0);" id="connect-btn-0" class="device-connection-button"
                    onmouseover="handleButtonHover(0, true)" onmouseout="handleButtonHover(0, false)">
                    <div class="device-name-display">
                        <span class="status-indicator" id="status-indicator-0"></span>
                        <span>DEVICE 1</span>
                    </div>
                    <div id="connection-status-info-0" class="connection-status-text">Not Connected</div>
                    <div id="device-side-info-0" class="device-position-info">
                        Position: <span id="device-position-0">—</span>
                    </div>
                </button>

                <button onclick="connectDevice(1);" id="connect-btn-1" class="device-connection-button"
                    onmouseover="handleButtonHover(1, true)" onmouseout="handleButtonHover(1, false)">
                    <div class="device-name-display">
                        <span class="status-indicator" id="status-indicator-1"></span>
                        <span>DEVICE 2</span>
                    </div>
                    <div id="connection-status-info-1" class="connection-status-text">Not Connected</div>
                    <div id="device-side-info-1" class="device-position-info">
                        Position: <span id="device-position-1">—</span>
                    </div>
                </button>
            </div>

            <!-- Sensor Display - Bottom Section (2 Columns: Left/Right) -->
            <div class="sensor-display-container">
                <!-- Left Side (0=left) -->
                <div class="sensor-side" id="left-side">
                    <div class="side-title">Left Foot</div>
                    <div class="sensor-grid" id="left-sensor-grid">
                        <!-- Accelerometer Card -->
                        <div class="sensor-card">
                            <div class="sensor-title">Accelerometer</div>
                            <div class="values">
                                <div class="value-row">
                                    <span class="value-label">X</span>
                                    <span class="value-number" id="acc-x-0">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Y</span>
                                    <span class="value-number" id="acc-y-0">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Z</span>
                                    <span class="value-number" id="acc-z-0">0.000</span>
                                </div>
                            </div>
                            <div class="meta-info">
                                <div>Timestamp: <span id="acc-timestamp-0">—</span></div>
                                <div>Packet: <span id="acc-packet-0">—</span></div>
                            </div>
                        </div>

                        <!-- Gyroscope Card -->
                        <div class="sensor-card">
                            <div class="sensor-title">Gyroscope</div>
                            <div class="values">
                                <div class="value-row">
                                    <span class="value-label">X</span>
                                    <span class="value-number" id="gyro-x-0">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Y</span>
                                    <span class="value-number" id="gyro-y-0">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Z</span>
                                    <span class="value-number" id="gyro-z-0">0.000</span>
                                </div>
                            </div>
                            <div class="meta-info">
                                <div>Timestamp: <span id="gyro-timestamp-0">—</span></div>
                                <div>Packet: <span id="gyro-packet-0">—</span></div>
                            </div>
                        </div>

                        <!-- Pressure Card -->
                        <div class="sensor-card">
                            <div class="sensor-title">Pressure</div>
                            <div class="values">
                                <div class="value-row">
                                    <span class="value-label">Sensor 1</span>
                                    <span class="value-number" id="press-0-0">0</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Sensor 2</span>
                                    <span class="value-number" id="press-1-0">0</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Sensor 3</span>
                                    <span class="value-number" id="press-2-0">0</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Sensor 4</span>
                                    <span class="value-number" id="press-3-0">0</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Sensor 5</span>
                                    <span class="value-number" id="press-4-0">0</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Sensor 6</span>
                                    <span class="value-number" id="press-5-0">0</span>
                                </div>
                            </div>
                            <div class="meta-info">
                                <div>Timestamp: <span id="press-timestamp-0">—</span></div>
                                <div>Packet: <span id="press-packet-0">—</span></div>
                            </div>
                        </div>

                        <!-- Quaternion Card -->
                        <!-- Quaternion Card -->
                        <div class="sensor-card">
                            <div class="sensor-title">Quaternion</div>
                            <div class="values">
                                <div class="value-row">
                                    <span class="value-label">W</span>
                                    <span class="value-number" id="quat-w-0">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">X</span>
                                    <span class="value-number" id="quat-x-0">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Y</span>
                                    <span class="value-number" id="quat-y-0">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Z</span>
                                    <span class="value-number" id="quat-z-0">0.000</span>
                                </div>
                            </div>
                            <div class="meta-info">
                                <div>Timestamp: <span id="quat-timestamp-0">—</span></div>
                                <div>Packet: <span id="quat-packet-0">—</span></div>
                            </div>
                        </div>

                        <!-- Status Card -->
                        <div class="sensor-card">
                            <div class="sensor-title">STATUS</div>
                            <!-- Status Information - Always visible -->
                            <div id="device-info-0" style="margin-top: 15px;">
                                <div class="info-row">
                                    <span class="info-label">Battery:</span>
                                    <span class="info-value" id="battery-0">—</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Mount Position:</span>
                                    <span class="info-value" id="mount-position-0">—</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Acc Range:</span>
                                    <span class="info-value" id="acc-range-0">—</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Gyro Range:</span>
                                    <span class="info-value" id="gyro-range-0">—</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Side (1=right) -->
                <div class="sensor-side" id="right-side">
                    <div class="side-title">Right Foot</div>
                    <div class="sensor-grid" id="right-sensor-grid">
                        <!-- Accelerometer Card -->
                        <div class="sensor-card">
                            <div class="sensor-title">Accelerometer</div>
                            <div class="values">
                                <div class="value-row">
                                    <span class="value-label">X</span>
                                    <span class="value-number" id="acc-x-1">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Y</span>
                                    <span class="value-number" id="acc-y-1">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Z</span>
                                    <span class="value-number" id="acc-z-1">0.000</span>
                                </div>
                            </div>
                            <div class="meta-info">
                                <div>Timestamp: <span id="acc-timestamp-1">—</span></div>
                                <div>Packet: <span id="acc-packet-1">—</span></div>
                            </div>
                        </div>

                        <!-- Gyroscope Card -->
                        <div class="sensor-card">
                            <div class="sensor-title">Gyroscope</div>
                            <div class="values">
                                <div class="value-row">
                                    <span class="value-label">X</span>
                                    <span class="value-number" id="gyro-x-1">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Y</span>
                                    <span class="value-number" id="gyro-y-1">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Z</span>
                                    <span class="value-number" id="gyro-z-1">0.000</span>
                                </div>
                            </div>
                            <div class="meta-info">
                                <div>Timestamp: <span id="gyro-timestamp-1">—</span></div>
                                <div>Packet: <span id="gyro-packet-1">—</span></div>
                            </div>
                        </div>

                        <!-- Pressure Card -->
                        <div class="sensor-card">
                            <div class="sensor-title">Pressure</div>
                            <div class="values">
                                <div class="value-row">
                                    <span class="value-label">Sensor 1</span>
                                    <span class="value-number" id="press-0-1">0</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Sensor 2</span>
                                    <span class="value-number" id="press-1-1">0</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Sensor 3</span>
                                    <span class="value-number" id="press-2-1">0</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Sensor 4</span>
                                    <span class="value-number" id="press-3-1">0</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Sensor 5</span>
                                    <span class="value-number" id="press-4-1">0</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Sensor 6</span>
                                    <span class="value-number" id="press-5-1">0</span>
                                </div>
                            </div>
                            <div class="meta-info">
                                <div>Timestamp: <span id="press-timestamp-1">—</span></div>
                                <div>Packet: <span id="press-packet-1">—</span></div>
                            </div>
                        </div>

                        <!-- Quaternion Card -->
                        <div class="sensor-card">
                            <div class="sensor-title">Quaternion</div>
                            <div class="values">
                                <div class="value-row">
                                    <span class="value-label">W</span>
                                    <span class="value-number" id="quat-w-1">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">X</span>
                                    <span class="value-number" id="quat-x-1">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Y</span>
                                    <span class="value-number" id="quat-y-1">0.000</span>
                                </div>
                                <div class="value-row">
                                    <span class="value-label">Z</span>
                                    <span class="value-number" id="quat-z-1">0.000</span>
                                </div>
                            </div>
                            <div class="meta-info">
                                <div>Timestamp: <span id="quat-timestamp-1">—</span></div>
                                <div>Packet: <span id="quat-packet-1">—</span></div>
                            </div>
                        </div>

                        <!-- Status Card -->
                        <div class="sensor-card">
                            <div class="sensor-title">STATUS</div>
                            <!-- Status Information - Always visible -->
                            <div id="device-info-1" style="margin-top: 15px;">
                                <div class="info-row">
                                    <span class="info-label">Battery:</span>
                                    <span class="info-value" id="battery-1">—</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Mount Position:</span>
                                    <span class="info-value" id="mount-position-1">—</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Acc Range:</span>
                                    <span class="info-value" id="acc-range-1">—</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Gyro Range:</span>
                                    <span class="info-value" id="gyro-range-1">—</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script src="../../src/ORPHE-INSOLE.js"></script>
    <script>
        // グローバル変数
        const insole = [new Orphe(0), new Orphe(1)];
        const isConnected = [false, false];

        // mount_positionとデバイスインデックスのマッピング
        // mount_position: 0=left, 1=right
        // deviceIndex: どのデバイス（0または1）がどちら側（0または1）にマップされるかを管理
        const deviceToSideMapping = {};

        // 初期化関数
        function init() {
            console.log("ORPHE Sensor Dashboard initialized");

            // 両デバイスを初期化
            for (let deviceIndex = 0; deviceIndex < 2; deviceIndex++) {
                // ORPHE CORE Init
                insole[deviceIndex].setup();

                // 接続イベント
                insole[deviceIndex].onConnect = function () {
                    updateConnectionStatus(deviceIndex, true);
                };

                insole[deviceIndex].onDisconnect = function () {
                    updateConnectionStatus(deviceIndex, false);
                    // マッピングをクリア
                    delete deviceToSideMapping[deviceIndex];
                };

                // センサーデータ受信イベント
                setupSensorCallbacks(deviceIndex);
            }
        }

        // センサーコールバック設定
        function setupSensorCallbacks(deviceIndex) {
            // 加速度センサー
            insole[deviceIndex].gotConvertedAcc = function (acc) {
                const side = deviceToSideMapping[deviceIndex];
                if (side !== undefined) {
                    updateValue(`acc-x-${side}`, acc.x);
                    updateValue(`acc-y-${side}`, acc.y);
                    updateValue(`acc-z-${side}`, acc.z);
                    document.getElementById(`acc-timestamp-${side}`).textContent = formatTimestamp(acc.timestamp);
                    document.getElementById(`acc-packet-${side}`).textContent = acc.packet_number || '—';
                }
            };

            // ジャイロスコープ
            insole[deviceIndex].gotConvertedGyro = function (gyro) {
                const side = deviceToSideMapping[deviceIndex];
                if (side !== undefined) {
                    updateValue(`gyro-x-${side}`, gyro.x);
                    updateValue(`gyro-y-${side}`, gyro.y);
                    updateValue(`gyro-z-${side}`, gyro.z);
                    document.getElementById(`gyro-timestamp-${side}`).textContent = formatTimestamp(gyro.timestamp);
                    document.getElementById(`gyro-packet-${side}`).textContent = gyro.packet_number || '—';
                }
            };

            // 圧力センサー
            insole[deviceIndex].gotPress = function (press) {
                const side = deviceToSideMapping[deviceIndex];
                if (side !== undefined) {
                    for (let i = 0; i < press.values.length; i++) {
                        document.getElementById(`press-${i}-${side}`).textContent = press.values[i];
                    }
                    document.getElementById(`press-timestamp-${side}`).textContent = formatTimestamp(press.timestamp);
                    document.getElementById(`press-packet-${side}`).textContent = press.packet_number || '—';
                }
            };

            // クォータニオン
            insole[deviceIndex].gotQuat = function (quat) {
                const side = deviceToSideMapping[deviceIndex];
                if (side !== undefined) {
                    updateValue(`quat-w-${side}`, quat.w);
                    updateValue(`quat-x-${side}`, quat.x);
                    updateValue(`quat-y-${side}`, quat.y);
                    updateValue(`quat-z-${side}`, quat.z);
                    document.getElementById(`quat-timestamp-${side}`).textContent = formatTimestamp(quat.timestamp);
                    document.getElementById(`quat-packet-${side}`).textContent = quat.packet_number || '—';
                }
            };
        }

        // デバイス接続関数
        function connectDevice(deviceIndex) {
            if (isConnected[deviceIndex]) {
                insole[deviceIndex].stop();
                updateConnectionStatus(deviceIndex, false);
            } else {
                insole[deviceIndex].begin()
                    .then(() => {
                        console.log(`Device ${deviceIndex + 1} connected`);

                        // begin()実行後、device_information.mount_positionを参照
                        setupDeviceMapping(deviceIndex);
                    })
                    .catch(error => {
                        console.error(`Device ${deviceIndex + 1} connection error:`, error);
                        const deviceName = deviceIndex === 0 ? 'Device 1' : 'Device 2';
                        alert(`${deviceName} connection failed: ` + error.message);
                    });
            }
        }

        // ボタンホバー効果処理 - CSS classes handle the hover effects now
        function handleButtonHover(deviceIndex, isHover) {
            // This function can be removed as CSS handles hover effects through classes
            // Keeping for backward compatibility, but actual styling is handled by CSS
        }

        // デバイスマッピング設定
        function setupDeviceMapping(deviceIndex) {
            try {
                // device_informationを直接参照
                const deviceInfo = insole[deviceIndex].device_information;
                console.log(`Device ${deviceIndex} info:`, deviceInfo);

                if (!deviceInfo) {
                    console.error(`Device information not available for device ${deviceIndex}`);
                    return;
                }

                // mount_positionから左右判定 (0=left, 1=right)
                const mountPosition = deviceInfo.mount_position;
                const side = mountPosition === 0 ? 0 : 1; // 0=left, 1=right

                deviceToSideMapping[deviceIndex] = side;
                console.log(`Device ${deviceIndex} mapped to side ${side} (${side === 0 ? 'left' : 'right'}) based on mount_position: ${mountPosition}`);

                // UIに左右情報を表示
                updateDevicePositionInfo(deviceIndex, side);

                // デバイス情報をステータスカードに表示
                updateDeviceInformation(deviceIndex, deviceInfo, side);

            } catch (error) {
                console.error(`Error setting up device mapping for device ${deviceIndex}:`, error);
            }
        }

        // デバイス情報表示更新
        function updateDeviceInformation(deviceIndex, deviceInfo, side) {
            try {
                // デバイス情報表示エリアを表示
                const deviceInfoArea = document.getElementById(`device-info-${side}`);
                if (deviceInfoArea) {
                    deviceInfoArea.style.display = 'block';
                }

                // バッテリー情報 (0: 少ない, 1: 普通, 2: フル)
                const batteryElement = document.getElementById(`battery-${side}`);
                if (batteryElement && deviceInfo.battery !== undefined) {
                    const batteryLevels = ['Low', 'Normal', 'Full'];
                    const batteryText = batteryLevels[deviceInfo.battery] || `Unknown (${deviceInfo.battery})`;
                    batteryElement.textContent = batteryText;
                }

                // マウントポジション
                const mountPositionElement = document.getElementById(`mount-position-${side}`);
                if (mountPositionElement && deviceInfo.mount_position !== undefined) {
                    const positionText = deviceInfo.mount_position === 0 ? 'Left Foot' : 'Right Foot';
                    mountPositionElement.textContent = positionText;
                }

                // 加速度センサーレンジ (0: 2g, 1: 4g, 2: 8g, 3: 16g)
                const accRangeElement = document.getElementById(`acc-range-${side}`);
                if (accRangeElement && deviceInfo.range && deviceInfo.range.acc !== undefined) {
                    const accRanges = ['±2g', '±4g', '±8g', '±16g'];
                    const accText = accRanges[deviceInfo.range.acc] || `±${deviceInfo.range.acc}g`;
                    accRangeElement.textContent = accText;
                }

                // ジャイロセンサーレンジ (0: 250, 1: 500, 2: 1000, 3: 2000 deg/s)
                const gyroRangeElement = document.getElementById(`gyro-range-${side}`);
                if (gyroRangeElement && deviceInfo.range && deviceInfo.range.gyro !== undefined) {
                    const gyroRanges = ['±250°/s', '±500°/s', '±1000°/s', '±2000°/s'];
                    const gyroText = gyroRanges[deviceInfo.range.gyro] || `±${deviceInfo.range.gyro}°/s`;
                    gyroRangeElement.textContent = gyroText;
                }

            } catch (error) {
                console.error(`Error updating device information for device ${deviceIndex}:`, error);
            }
        }

        // デバイス位置情報表示更新
        function updateDevicePositionInfo(deviceIndex, side) {
            const deviceSideInfo = document.getElementById(`device-side-info-${deviceIndex}`);
            const devicePosition = document.getElementById(`device-position-${deviceIndex}`);

            if (deviceSideInfo && devicePosition) {
                const sideText = side === 0 ? 'Left Foot' : 'Right Foot';
                devicePosition.textContent = sideText;
                deviceSideInfo.classList.add('visible');
            }
        }

        // 接続状態更新
        function updateConnectionStatus(deviceIndex, connected) {
            isConnected[deviceIndex] = connected;
            const statusIndicator = document.getElementById(`status-indicator-${deviceIndex}`);
            const connectionStatusInfo = document.getElementById(`connection-status-info-${deviceIndex}`);
            const connectBtn = document.getElementById(`connect-btn-${deviceIndex}`);

            if (connected) {
                statusIndicator.className = 'status-indicator connected';
                if (connectionStatusInfo) connectionStatusInfo.textContent = 'Connected';
                connectBtn.classList.add('connected');
            } else {
                statusIndicator.className = 'status-indicator';
                if (connectionStatusInfo) connectionStatusInfo.textContent = 'Not Connected';
                connectBtn.classList.remove('connected');

                // 左右情報を非表示
                const deviceSideInfo = document.getElementById(`device-side-info-${deviceIndex}`);
                if (deviceSideInfo) {
                    deviceSideInfo.classList.remove('visible');
                }

                // ステータスカードの更新 (デバイス情報は常に表示のため何もしない)
                const side = deviceToSideMapping[deviceIndex];
                if (side !== undefined) {
                    // デバイス情報は常に表示されているため、非表示処理は不要
                }
            }
        }

        // 値更新関数
        function updateValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = typeof value === 'number' ? value.toFixed(3) : value;
            }
        }

        // タイムスタンプフォーマット
        function formatTimestamp(timestamp) {
            if (!timestamp) return '—';
            const date = new Date(timestamp);
            return date.toLocaleTimeString() + '.' + String(date.getMilliseconds()).padStart(3, '0');
        }

        // 初期化実行
        window.addEventListener('load', init);
    </script>
</body>

</html>